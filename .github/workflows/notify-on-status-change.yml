name: Notificaci√≥n por cambios de estado en Upptime

on:
  push:
    branches:
      - master

jobs:
  notify:
    name: Notificar por Telegram si cambia el estado
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        
      - name: Extraer mensaje del √∫ltimo commit
        id: estado
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "√öltimo commit: $COMMIT_MSG"

          # Determinar el tipo de cambio
          echo "√öltimo commit crudo:"
          echo "$COMMIT_MSG" | cat -v
          
          if echo "$COMMIT_MSG" | grep -qF "üü•"; then
            echo "estado=down" >> $GITHUB_OUTPUT
          elif echo "$COMMIT_MSG" | grep -qF "‚ö†"; then
            echo "estado=degraded" >> $GITHUB_OUTPUT
          elif echo "$COMMIT_MSG" | grep -qF "üü©"; then
            echo "estado=up" >> $GITHUB_OUTPUT
          else
            echo "estado=none" >> $GITHUB_OUTPUT
          fi

      - name: Enviar notificaci√≥n si hubo ca√≠da
        if: ${{ steps.estado.outputs.estado == 'down' }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="üö® Ca√≠da detectada por Upptime del ambiente de producci√≥n. Verifica üëâ https://Suns2794.github.io/ariaxa-upptime/"
            
      - name: Enviar notificaci√≥n si hay rendimiento degradado
        if: ${{ steps.estado.outputs.estado == 'degraded' }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="‚ö†Ô∏è Advertencia: uno o m√°s sitios presentan rendimiento degradado. Revisa üëâ https://Suns2794.github.io/ariaxa-upptime/"
