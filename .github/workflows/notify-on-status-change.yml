name: Notificaci贸n por cambios de estado en Upptime

on:
  push:
    branches:
      - master

jobs:
  notify:
    name: Notificar por Telegram si cambia el estado
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        
      - name: Extraer mensaje del 煤ltimo commit
        id: estado
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "ltimo commit: $COMMIT_MSG"

          # Determinar el tipo de cambio
          if echo "$COMMIT_MSG" | grep -q ""; then
            echo "estado=down" >> $GITHUB_OUTPUT
          elif echo "$COMMIT_MSG" | grep -q "锔"; then
            echo "estado=degraded" >> $GITHUB_OUTPUT
          elif echo "$COMMIT_MSG" | grep -q ""; then
            echo "estado=up" >> $GITHUB_OUTPUT
          else
            echo "estado=none" >> $GITHUB_OUTPUT
          fi

      - name: Enviar notificaci贸n si hubo ca铆da
        if: ${{ steps.estado.outputs.estado == 'down' }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text=" Ca铆da detectada por Upptime del ambiente de producci贸n. Verifica  https://Suns2794.github.io/ariaxa-upptime/"
            
      - name: Enviar notificaci贸n si hay rendimiento degradado
        if: ${{ steps.estado.outputs.estado == 'degraded' }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="锔 Advertencia: uno o m谩s sitios presentan rendimiento degradado. Revisa  https://Suns2794.github.io/ariaxa-upptime/"
